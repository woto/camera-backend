<% content_for :title, "Event ##{@event.id}" %>

<% content_for :head do %>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css">
  <script defer src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.js"></script>
<% end %>

<div class="container" data-controller="video-switcher"
     data-video-switcher-captures-value="<%= @switcher_captures.to_json %>"
     data-video-switcher-current-id-value="<%= @base_capture&.id %>">
  <div class="page-actions">
    <div class="navigation-links">
      <%= link_to events_path, class: "back-button" do %>
        All events
      <% end %>

      <div class="prev-next-links">
        <% if @next_event %>
          <%= link_to "« Newer", event_path(@next_event), class: "nav-link" %>
        <% end %>
        <% if @prev_event %>
          <%= link_to "Older »", event_path(@prev_event), class: "nav-link" %>
        <% end %>
      </div>
    </div>
    <% if current_user %>
      <div class="page-actions-buttons">
        <%= button_to(@event.hidden? ? "Сделать открытым" : "Скрыть событие",
          set_visibility_event_path(@event, hidden: !@event.hidden?),
          method: :patch,
          class: "secondary-button") %>
        <%= button_to "Delete event", event_path(@event), method: :delete, data: { turbo_confirm: "Delete this event and all its captures?" }, class: "danger-button" %>
      </div>
    <% end %>
  </div>

  <h1>
    Event <%= @event.captured_at.strftime("%Y-%m-%d %H:%M:%S %Z") %>
    <span class="event-badge <%= @event.hidden? ? "is-hidden" : "is-open" %>">
      <%= @event.hidden? ? "Скрыто" : "Открыто" %>
    </span>
  </h1>

  <% if @captures.any? %>
    <div class="capture-card">
      <div class="capture-header">
        <span data-video-switcher-target="label">Загрузка…</span>
        <span class="capture-time"><%= @base_capture&.created_at&.strftime("%Y-%m-%d %H:%M:%S %Z") %></span>
      </div>

      <div class="capture-video">
        <%= video_tag "",
          controls: true,
          preload: "metadata",
          class: "video-player",
          data: { video_switcher_target: "player" } %>
      </div>

      <div class="camera-switcher">
        <% @captures.each do |capture| %>
          <button type="button"
                  class="ghost-button"
                  data-action="click->video-switcher#switch"
                  data-video-switcher-id-param="<%= capture.id %>">
            Камера <%= capture.id %><%= capture == @base_capture ? " (база)" : "" %>
          </button>
        <% end %>
      </div>
    </div>
  <% else %>
    <p>No captures for this event.</p>
  <% end %>

  <% if current_user && @captures.any? %>
    <div class="admin-tools">
      <h3>Админ · Синхронизация</h3>
      <div class="admin-actions">
        <% @captures.each do |capture| %>
          <%= button_to "Сделать базой ##{capture.id}", set_base_event_path(@event, capture_id: capture.id), method: :post, class: "secondary-button" %>
        <% end %>
      </div>

      <div class="admin-actions">
        <%= form_with url: sync_offsets_event_path(@event), method: :post, local: true do |f| %>
          <div class="form-row">
            <label>Базовый ролик</label>
            <%= select_tag :capture_id, options_from_collection_for_select(@captures, :id, :id, @base_capture&.id), include_blank: false %>
          </div>
          <div class="form-row">
            <label>Длительность анализа (сек)</label>
            <%= number_field_tag :analyze_duration, 90, step: 1 %>
          </div>
          <div class="form-row">
            <label>Sample rate (Hz)</label>
          <%= number_field_tag :sample_rate, 8000, step: 1000 %>
        </div>
        <%= f.submit "Запустить синхронизацию", class: "primary-button" %>
      <% end %>
      </div>

      <h3>Админ · Ориентация</h3>
      <div class="admin-actions">
        <% @captures.each do |capture| %>
          <div class="form-row">
            <div class="form-label">
              Capture ##<%= capture.id %> (текущая: <%= capture.rotation_degrees || 0 %>°)
            </div>
            <div class="form-controls">
              <% [0, 90, 180, 270].each do |deg| %>
                <%= button_to "#{deg}°", set_rotation_event_path(@event, capture_id: capture.id, rotation: deg), method: :patch, class: "ghost-button" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
